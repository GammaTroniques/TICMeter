<!-- code une page html pour téléphone -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Linky TIC ESP32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <form action="/save-config" method="POST" id="form">
        <div class="titre black-text">
            <h1>Linky TIC ESP32</h1>
        </div>
        <div class="bloc">
            <h2>Configuration Wifi</h2>
            <div class="input-field">
                <h2>SSID</h2>
                <input type="text" name="wifi-ssid" placeholder="Livebox ..." max="50" />
            </div>
            <div class="input-field">
                <h2>PWD</h2>
                <input type="password" name="wifi-password" max="50" />
            </div>
        </div>
        <div class="bloc">
            <h2>Configuration Linky</h2>
            <p>Faites défiler les menus de votre compteur jusqu'à trouver l'option "MODE TIC"</p>
            <label>
                <input type="radio" name="linky-mode" value="0" checked>
                <div class="linky-selector">
                    <h3 class="black-text">Mode Historique</h3>
                </div>
            </label>

            <label>
                <input type="radio" name="linky-mode" value="1">
                <div class="linky-selector">
                    <h3 class="black-text">Mode Standard</h3>
                </div>
            </label>

        </div>

        <div class="bloc server-selector">
            <h2>Mode de connexion</h2>

            <div>
                <label>
                    <input type="radio" name="server-mode" value="0" checked>
                    <img src="web.jpg" alt="WEB">
                </label>

                <label>
                    <input type="radio" name="server-mode" value="1">
                    <img src="mqtt.jpg" alt="MQTT">
                </label>
                <label>
                    <input type="radio" name="server-mode" value="2">
                    <img src="tuya.jpg" alt="Tuya">
                </label>
            </div>

            <div class="web">
                <div class="input-field">
                    <h3>SERVER</h3>
                    <input type="text" name="web-url" placeholder="192.168.2.10:3001" />
                </div>
                <div class="input-field">
                    <h3>POST URL</h3>
                    <input type="text" name="web-post" placeholder="/post" max="50" />
                </div>
                <div class="input-field">
                    <h3>CONFIG URL</h3>
                    <input type="text" name="web-config" placeholder="/config" max="50" />
                </div>
                <div class="input-field">
                    <h3>TOKEN</h3>
                    <input type="text" name="web-token" placeholder="pwGGHTFaOm" max="50" />
                </div>
            </div>

            <div class="mqtt">
                <div class="input-field">
                    <h3>IP</h3>
                    <input type="text" name="mqtt-host" max="50" />
                </div>
                <div class="input-field">
                    <h3>Port</h3>
                    <input type="text" name="mqtt-port" max="50" />
                </div>
                <div class="input-field">
                    <h3>User</h3>
                    <input type="text" name="mqtt-user" max="50" />
                </div>
                <div class="input-field">
                    <h3>PWD</h3>
                    <input type="password" name="mqtt-password" max="50" />
                </div>
                <div class="input-field">
                    <h3>Topic</h3>
                    <input type="text" name="mqtt-topic" max="50" />
                </div>
                <div class="input-field">
                    <h3>Home Assistant Discovery</h3>
                    <input type="checkbox" name="mqtt-ha-discovery" value="1" />
                </div>
            </div>
            <div class="tuya">
                <span id="tuya-text"></span>
                <a href="" id="tuyalink">Go Tuya</a>
            </div>
        </div>
        <input type="submit" value="Engregistrer">
    </form>
</body>

<!-- <script src="index.js"></script> -->

<script>
    const serverMode = document.getElementsByName("server-mode");
    serverMode.forEach((element) => {
        element.addEventListener("change", (event) => {
            console.log(event.target.value);
            const web = document.querySelector(".web");
            const mqtt = document.querySelector(".mqtt");
            const tuya = document.querySelector(".tuya");
            web.style.display = "none";
            mqtt.style.display = "none";
            tuya.style.display = "none";
            if (event.target.value == 0) {
                web.style.display = "block";
            } else if (event.target.value == 1) {
                mqtt.style.display = "block";
            } else if (event.target.value == 2) {
                tuya.style.display = "block";
            }
        });
    });
    var tuya = {
        productId: "",
        uuid: "",
    }
    //fetch config
    fetch("/config")
        .then((response) => response.json())
        .then((data) => {
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const element = data[key];
                    if (key == "server-mode") {
                        continue;
                    }
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = element;
                    }
                }
            }
            if ("server-mode" in data) {
                const web = document.querySelector(".web");
                const mqtt = document.querySelector(".mqtt");
                const radio = document.getElementsByName("server-mode");
                if (data["server-mode"] == 0) {
                    web.style.display = "flex";
                    mqtt.style.display = "none";
                    radio[0].checked = true;
                    radio[1].checked = false;
                } else {
                    web.style.display = "none";
                    mqtt.style.display = "flex";
                    radio[0].checked = false;
                    radio[1].checked = true;
                    if (data["server-mode"] == 2) { //mqtt + ha
                        const mqttHaDiscovery = document.querySelector(`[name="mqtt-ha-discovery"]`);
                        mqttHaDiscovery.checked = 1;
                    }
                }
            }

            if ("linky-mode" in data) {
                const linkyMode = document.querySelector(`[name="linky-mode"][value="${data["linky-mode"]}"]`);
                linkyMode.checked = true;
            }

            if ("tuya-productID" in data) {
                tuya.productId = data["tuya-productID"];
                const tuyaText = document.querySelector("#tuya-text");
                tuyaText.innerHTML = `Product ID: ${tuya.productId}`;
                const tuyaLink = document.querySelector("#tuyalink");
                tuyaLink.href = `https://smartapp.tuya.com/s/p?p=${tuya.productId}&uuid=${tuya.uuid}&v=2.0`;
            }
            if ("tuya-uuid" in data) {
                tuya.uuid = data["tuya-uuid"];
                const tuyaText = document.querySelector("#tuya-text");
                tuyaText.innerHTML = `Product ID: ${tuya.productId}`;
                const tuyaLink = document.querySelector("#tuyalink");
                tuyaLink.href = `https://smartapp.tuya.com/s/p?p=${tuya.productId}&uuid=${tuya.uuid}&v=2.0`;
            }
        });

</script>

</html>