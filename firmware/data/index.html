<!-- code une page html pour téléphone -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>TICMeter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <form action="/save-config" method="POST" id="form">
        <div class="titre black-text">
            <h1>TICMeter</h1>
        </div>
        <div class="bloc">
            <h2>Configuration Wifi</h2>
            <div class="wifi">
                <div class="input-field">
                    <h2>SSID</h2>
                    <button type="button" onclick="wifi_scan()">Scanner les réseaux WiFi</button>

                    <!-- <input type="text" name="wifi-ssid" placeholder="Livebox ..." maxlength="32" /> -->
                </div>
                <div class="wifi-list">
                    <label>
                        <input type="radio" name="wifi-ssid">
                        <img src="wifi-2.svg" alt="wifi" />
                    </label>

                </div>
                <div class="input-field">
                    <h2>PWD</h2>
                    <input type="password" name="wifi-password" maxlength="64" />
                </div>
            </div>
        </div>
        <div class="bloc">
            <h2>Configuration Linky</h2>
            <p>Faites défiler les menus de votre compteur jusqu'à trouver l'option "MODE TIC"</p>
            <label>
                <input type="radio" name="linky-mode" value="0" checked>
                <div class="linky-selector">
                    <h3 class="black-text">Mode Historique</h3>
                </div>
            </label>

            <label>
                <input type="radio" name="linky-mode" value="1">
                <div class="linky-selector">
                    <h3 class="black-text">Mode Standard</h3>
                </div>
            </label>

        </div>

        <div class="bloc server-selector">
            <h2>Mode de connexion</h2>

            <div>
                <label>
                    <input type="radio" name="server-mode" value="1" checked>
                    <img src="web.jpg" alt="WEB">
                </label>
                <label>
                    <input type="radio" name="server-mode" value="2">
                    <img src="mqtt.png" alt="MQTT">
                </label>
                <label>
                    <input type="radio" name="server-mode" value="4">
                    <img src="zigbee.png" alt="Zigbee">
                </label>
                <label>
                    <input type="radio" name="server-mode" value="5">
                    <img src="tuya.png" alt="Tuya">
                </label>
            </div>

            <div class="web">
                <div class="input-field">
                    <h3>SERVER</h3>
                    <input type="text" name="web-url" placeholder="192.168.2.10:3001" maxlength="100" />
                </div>
                <div class="input-field">
                    <h3>POST URL</h3>
                    <input type="text" name="web-post" placeholder="/post" maxlength="50" />
                </div>
                <div class="input-field">
                    <h3>CONFIG URL</h3>
                    <input type="text" name="web-config" placeholder="/config" maxlength="50" />
                </div>
                <div class="input-field">
                    <h3>TOKEN</h3>
                    <input type="text" name="web-token" placeholder="pwGGHTFaOm" maxlength="100" />
                </div>
            </div>

            <div class="mqtt">
                <div class="input-field">
                    <h3>IP</h3>
                    <input type="text" name="mqtt-host" maxlength="100" />
                </div>
                <div class="input-field">
                    <h3>Port</h3>
                    <input type="number" name="mqtt-port" max="65535" />
                </div>
                <div class="input-field">
                    <h3>User</h3>
                    <input type="text" name="mqtt-user" maxlength="50" />
                </div>
                <div class="input-field">
                    <h3>PWD</h3>
                    <input type="password" name="mqtt-password" maxlength="50" />
                </div>
                <div class="input-field">
                    <h3>Topic</h3>
                    <input type="text" name="mqtt-topic" maxlength="101" />
                </div>
                <div class="input-field">
                    <h3>Home Assistant Discovery</h3>
                    <input type="checkbox" name="mqtt-ha-discovery" value="1" />
                </div>
            </div>
            <div class="tuya">
                <div class="input-field">
                    <h3>Device UUID</h3>
                    <input type="text" name="tuya-device-uuid" maxlength="29" />
                </div>
                <div class="input-field">
                    <h3>Device Auth</h3>
                    <input type="text" name="tuya-device-auth" maxlength="49" />
                </div>
            </div>
            <div class="zigbee">
                <p>Il n'y a pas de configuration supplémentaire.</p>
                <p>Vous pouvez cliquer sur enregistrer et utiliser le
                    bouton pour lancer l'appairage.</p>
            </div>
        </div>
        <input type="submit" value="Engregistrer">
    </form>
</body>

<!-- <script src="index.js"></script> -->

<script>
    const serverMode = document.getElementsByName("server-mode");
    const web = document.querySelector(".web");
    const mqtt = document.querySelector(".mqtt");
    const tuya = document.querySelector(".tuya");
    const zigbee = document.querySelector(".zigbee");
    const radio = document.getElementsByName("server-mode");
    web.style.display = "none";
    mqtt.style.display = "none";
    tuya.style.display = "none";
    zigbee.style.display = "none";
    for (let i = 0; i < radio.length; i++) {
        radio[i].checked = false;
    }

    serverMode.forEach((element) => {
        element.addEventListener("change", (event) => {
            console.log(event.target.value);

            web.style.display = "none";
            mqtt.style.display = "none";
            tuya.style.display = "none";
            zigbee.style.display = "none";
            switch (event.target.value) {
                case "1":
                    web.style.display = "block";
                    break;
                case "2":
                    mqtt.style.display = "block";
                    break;
                case "3":
                    mqtt.style.display = "block";
                    break;
                case "4":
                    zigbee.style.display = "block";
                    break;
                case "5":
                    tuya.style.display = "block";
                    break;
            }
        });
    });
    //fetch config
    fetch("/config")
        .then((response) => response.json())
        .then((data) => {
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const element = data[key];
                    if (key == "server-mode") {
                        continue;
                    }
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = element;
                    }
                }
            }
            if ("server-mode" in data) {
                web.style.display = "none";
                mqtt.style.display = "none";
                tuya.style.display = "none";
                zigbee.style.display = "none";
                for (let i = 0; i < radio.length; i++) {
                    radio[i].checked = false;
                }

                switch (data["server-mode"]) {
                    case 1:
                        web.style.display = "flex";
                        radio[0].checked = true;
                        break;
                    case 2:
                    case 3:
                        mqtt.style.display = "flex";
                        radio[1].checked = true;
                        if (data["server-mode"] == 2) { //mqtt + ha
                            const mqttHaDiscovery = document.querySelector(`[name="mqtt-ha-discovery"]`);
                            mqttHaDiscovery.checked = 1;
                        }
                        break;
                    case 4:
                        zigbee.style.display = "block";
                        radio[2].checked = true;
                        break;
                    case 5:
                        tuya.style.display = "block";
                        radio[3].checked = true;
                        break;
                }
            }

            if ("linky-mode" in data) {
                const linkyMode = document.querySelector(`[name="linky-mode"][value="${data["linky-mode"]}"]`);
                linkyMode.checked = true;
            }

            if ("tuya-device-uuid" in data) {
                const tuyaUUID = document.getElementsByName("tuya-device-uuid");
                tuyaUUID.value = data["tuya-device-uuid"];
            }
            if ("tuya-device-auth" in data) {
                const tuyaAuth = document.getElementsByName("tuya-device-auth");
                tuyaAuth.value = data["tuya-device-auth"];
            }
        });


    function wifi_scan() {
        fetch("/wifi-scan")
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                const wifiList = document.querySelector(".wifi-list");
                wifiList.innerHTML = "";
                const ap = data["ap"];
                for (let i = 0; i < ap.length; i++) {
                    const element = ap[i];
                    console.log(element);
                    const label = document.createElement("label");
                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = "wifi-ssid";
                    input.value = element.ssid;
                    label.appendChild(input);
                    const img = document.createElement("img");
                    img.src = "wifi-2.svg";
                    label.appendChild(img);
                    wifiList.appendChild(label);
                }
            });
    }
</script>

</html>